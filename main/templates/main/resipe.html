{% extends 'main/base.html' %}
{% block title %} {{ title }} {% endblock %}

{% block script %}
    id = {{id_recipe}};
    ingredients = [
{% for a in ingredients %}
   [ ['{{ a.name }}'],['{{ a.value }}']],
{% endfor %}
    ];
    function test(){

        var count = document.getElementById("count_ingredients").value;
        var table = "<thead>"+
            "<tr>"+
                "<th >Название ингридиенты</th>" +
                "<th>вес в граммах</th>"+
            "</tr>"+
        "</thead>";
        for (var a = 0; a < ingredients.length; a++){
            var count_value = parseInt(ingredients[a][1])*count ;
             table += "<tbody >"+
             "<td>"+ingredients[a][0]+"</td>"+
             "<td>"+count_value.toString()+"</td>"+
            " </tbody>";

        }
        document.getElementById("main_div_ingredients").innerHTML = table;
    }
    function delete_coment_display_none(comment_id){
      document.getElementById(comment_id).style.display = "none";

    }
    function delete_coment(url, comment_id){
      $.ajax({
                  url: url,
                  type: 'POST',
                  data: { },
                  success: function(data) {
                    document.getElementById(comment_id).style.animationName = "trans";
                    document.getElementById(comment_id).style.animationDuration = "1s";
                    document.getElementById(comment_id).style.animationTimingFunction = "1s";
                    document.getElementById(comment_id).style.animationIterationCount = "1";
                    document.getElementById(comment_id).style.animationPlayState = "running";
                    document.getElementById(comment_id).style.animationFillMode = "forwards";
                    setTimeout(delete_coment_display_none, 1000, comment_id);


                  },
              });
    }
    function add_coment(url){
      text_coment = document.getElementById("text_new_coment").value;
      if (text_coment != ""){
        $.ajax({
        url: url,
        type: 'POST',
        data: {'text_coment':text_coment
        },
        success: function (data) {
            var coment_html = document.getElementById("all_coment").innerHTML;
            document.getElementById("all_coment").innerHTML = data + coment_html;
            document.getElementById("text_new_coment").value = "";
        }
      });
    }else{
      alert("Вы ввели пустое значение! ");
    }



    }
    /*
      1 - кнопка
      2 - поле для ввода

    */
    function step_1_edit_coment(input_botton, input_text, url_updata, comment_id){
             document.getElementById(input_botton).innerHTML = "<input type=\"button\" value = \"Сохранить\" onclick=\"step_2_edit_coment('"+input_botton+"','"+input_text+"', '"+url_updata+"' , '"+comment_id+"' )\">" ;
             var old_coment = document.getElementById(input_text).innerHTML;
             document.getElementById(input_text).innerHTML = "<input type=\"text\" value = \""+old_coment+"\" id = \""+input_text+"T\">" ;
        // "<input type=\"button\" value = \"Сохранить\" onclick=\"step_2_edit_coment()\">" ;
    }
    function step_2_edit_coment(input_botton, input_text, url_updata, comment_id){
       document.getElementById(input_botton).innerHTML = "<input type=\"button\" value = \"Редактировать\" onclick=\"step_1_edit_coment('"+input_botton+"','"+input_text+"', '"+url_updata+"' )\">" ;
       var new_coment = document.getElementById(input_text+"T").value;
       document.getElementById(input_text).innerHTML = new_coment ;

       $.ajax({
                   url: url_updata,
                   type: 'POST',
                   data: { },
                   success: function(data) {
                     document.getElementById(comment_id).style.animationName = "trans";
                    document.getElementById(comment_id).style.animationDuration = "0.5s";
                    document.getElementById(comment_id).style.animationTimingFunction = "0.5s";
                    document.getElementById(comment_id).style.animationIterationCount = "1";
                    document.getElementById(comment_id).style.animationPlayState = "running";
                    document.getElementById(comment_id).style.animationFillMode = "forwards";

                    setTimeout(delete_coment_display_none, 500, comment_id);
                    setTimeout(add_update_coment, 550, 'add_coment/'+id, new_coment);
                   }
      });
    }
    function add_update_coment(url, text_coment){
      let result_RegExp = text_coment.match(/.{1,100}/g);
        if (result_RegExp.length != 0){
          $.ajax({
          url: url,
          type: 'POST',
          data: {'text_coment':text_coment
          },
          success: function (data) {
              var coment_html = document.getElementById("all_coment").innerHTML;
              document.getElementById("all_coment").innerHTML = data + coment_html;
              }
        });
      }
    }


{% endblock %}
{% block content %}
<div class="main_welcom">
    <h1>{{ heading }}
        {% if  recipe.user == user %}
            <a href="/recipe/edit_page/{{ recipe.id }}">
                <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
            </a>
        {% endif %}
    </h1>

    <div class="main_center" style="margin: auto; margin-top: 30px;">
        <div class="form_left" style="margin-right: 50px;">
            <i class="fa fa-clock-o" aria-hidden="true"></i> {{ hours }}:{{ minutes }}
        </div>
        <div class="form_left" style="margin-right: -50px;">
            {% if user.is_authenticated %}
                {% if favorite_status.user.id == user.id %}
                <a href = "delete_favorite/{{ id_recipe }}">
                    <button type="button" class="btn btn-outline-warning"
                            style=" width: 260px; height: 65px;">
                        Удалить из избранного
                    </button>
                </a>
                {% else %}
                    <a href = "add_favorite/{{ id_recipe }}">
                        <button type="button" class="btn btn-outline-warning"
                            style=" width: 260px; height: 65px;">
                        Добавить в избранное
                        </button>
                    </a>
                {% endif %}
            {% endif %}
        </div>

        <div class="text_right">
            {% if user.is_authenticated %}
                {% for a in 6|get_range %}
                    <a href="push_rating/{{ id_recipe }}/{{ a }}">
                        <input type="button" value="{{ a }}">
                    </a>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <div class="main_center" style="margin: auto; margin-top: 55px;">
        <div class="form_left" style="margin: auto; margin-right: 150px; margin-bottom: 40px; ">
            {% if images != "" %}
                 <img src="{{ images.url }}" alt="Картошка" width="380px" height="450px">
            {% endif %}
        </div>
        <div class="text_right" style="margin: auto;">
            <table class="table table-striped">
                 <tbody>
                 <tr style="display: none;"><td></td></tr>
                {% if autor %}
                    <tr><td>Автор</td> <td>{{ autor }}</td></tr>
                {% else %}
                    <tr><td>Автор</td> <td>Удалён</td></tr>
                {% endif %}

                {% if meal %}
                <tr><td>Тип</td> <td> {{ meal }} </td></tr>
                {% endif %}

                {% if complexity %}
                    <tr><td>Сложность</td> <td>{{ complexity }}</td></tr>
                {% endif %}


                {% if user.is_authenticated %}
                    {% if rating.here_rating == "zero" %}
                        <tr><td>Ваш рейтинг</td> <td> Нет оценки</td></tr>
                    {% else %}
                           <tr><td>Ваш рейтинг</td> <td> {{ rating.here_rating.rating }} </td></tr>
                    {% endif %}
                {% endif %}

                {% if rating.rating %}
                    <tr><td>Общий рейтинг</td> <td>{{ rating.rating }} / 5</td></tr>
                {% endif %}

                {% if rating.count %}
                    <tr><td>Всего оценили</td> <td>{{ rating.count }}</td></tr>
                {% endif %}

                {% if  recipe.user == user %}
                    <tr>
                        <td>
                            <a href="/recipe/delete_recipe/{{ recipe.id }}">
                                <button type="button" class="btn btn-danger"
                                        style=" width: 180px; height: 55px;">Удалить рецепт
                                </button>
                            </a>
                        </td>
                    </tr>
                {% endif %}
                 </tbody>
            </table>
        </div>
    </div>
    <div class="main_center" style="margin: auto;">
            <div class="text_center" style="margin: auto;"> {{ text }}<br></div>
    </div><br>
    {% if video_url != "NULL"%}
            <h2 align="center">Видеоинструкция</h2>
            <p>
                <iframe width="800" height="500" src="{{ video_url }}">
            </iframe>
                </p>
        {% endif %}
    <h2 align="center" style="margin-top: 30px;">Ингредиенты</h2>
    <div class="box" style="margin: auto; margin-top: 30px;">
        {% csrf_token %}
        <div class="main_center">
            <div class="form_left" style="margin: auto; margin-right: 50px;">Введите количество порций: </div>
            <div class="text_right" style="margin: auto;">
                <input type="number" min = 1 max = 12 value = 1 size = 10 id="count_ingredients" onclick="test()">
            </div>
        </div>
    </div>
    <table class="table table-striped table-hover" id = "main_div_ingredients"
           style="justify-content: center; text-align: center; width: auto; margin-top: 60px;">
        <thead>
            <tr>
                <th scope="col">Название</th>
                <th scope="col">Вес в граммах</th>
            </tr>
        </thead>

        {% for a in ingredients %}
            <tbody>
            <tr>
                <td>{{ a.name }}</td>
                <td>{{ a.value }}</td>
            </tr>
            </tbody>
        {% endfor%}

    </table>

        <!-- Форма для ввода -->
        {% if user.is_authenticated %}
            <div>
                <h3 align = "center" style="margin-top: 40px;">Добавить комментарий</h3>
                <form action="#" method = "get" class="box" style="margin: auto; margin-top: 60px;">
                    <input type="text" id="text_new_coment" placeholder="Текст комментария"><br><br>
                    <div class="mb-3" style="margin: auto;">
                        <div class="main_center">
                            <button type="button"
                                    class="btn btn-outline-success"
                                    onclick = "add_coment('add_coment/{{ id_recipe}}')"
                                    style="margin: auto; border-radius: 34px;">
                                <i class="fa fa-plus-square" aria-hidden="true"></i>     Добавить коментарий
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        {% endif %}
        <h2 align = "center">Комментарии</h2>
        <div id = "all_coment" style="width: 800px; margin: auto;">
            {% for a in comments %}
                <div id = "coment{{ a.id }}" style="width: 800px; height: auto;">
                    <div class="container mt-5" style="width: 800px; margin: auto;">
                         <div class="card" style="width: 800px; margin: auto;">
                                <div class="card-header" style="justify-content: center; text-align: center;">
                                    <h5>Автор {{ a.user.username }} </h5>
                                    <i class="fa fa-clock-o" aria-hidden="true"></i> {{ a.data_time }}
                                </div>
                                <div class="row">
                                    <div class="col-md-8" style="margin: auto;">
                                        <samp id = "coment_edit_text{{ a.id }}" style="width: 800px;" >{{ a.text }}</samp><br>
                                        {% if a.user.id == user.id %}
                                            <div class="box" style="width: auto;">
                                                <div class="main_center" style="margin: auto;">
                                                    <div class="form_left" style="margin-right: 0;">
                                                        <button type="submit"
                                                                value = "Удалить"
                                                                onclick="delete_coment('delete_coment/{{ a.id }}/{{ id_recipe }}','coment{{ a.id }}')">Удалить</button>
                                                    </div>
                                                    <div class="text_right">
                                                        <samp id = "coment_edit_botton{{ a.id }}" >
                                                            <button type="button"
                                                                    value = "Редактировать"
                                                                    class="btn btn-outline-info"
                                                                    style="border-radius: 34px; height: 65px;"
                                                                    onclick="step_1_edit_coment('coment_edit_botton{{ a.id }}','coment_edit_text{{ a.id }}', 'delete_coment/{{ a.id }}/{{ id_recipe }}','coment{{ a.id }}')">
                                                                Редактировать
                                                            </button>
                                                        </samp>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                         </div>
                    </div>
                </div>
            {% endfor %}
        </div>
</div>
{% endblock %}
{% block style %}
    @keyframes trans {
        from {opacity:1 }
        to {opacity:0; }
    }
{% endblock %}